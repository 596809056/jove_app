<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/biaodan.css" />
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="padding-right: 15px;">
			<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
				<span class="mui-icon mui-icon-left-nav"></span>
			</button>
			<h1 class="mui-title">中富移动办公</h1>
		</header>
		<div class="mui-content" id="">

			<div id="hcaption">
				开料首检
			</div>
			<ul class="mui-list-unstyled mui-table-view biaodan" style="margin-top: 0;">
				<li class="mui-table-view-cell mui-collapse mui-active" style="color: cadetblue;text-align: left;padding: 0.5rem 1rem;">
					<a class="mui-navigate-right" href="#">条码信息</a>
					<div class="mui-collapse-content">
						<p><input id="code" type="text" value="" data-id="tiaoma1" placeholder="点击扫描" /></p>
					</div>
					<div class="mui-collapse-content">
						<p><input id="barcode" type="text" class="scan" value="" data-id="tiaoma" placeholder="轻触以打开扫描" readonly="readonly" /></p>
					</div>
				</li>
				<li class="mui-table-view-cell mui-collapse" style="color: royalblue;text-align: left;padding:0.5rem 1rem;">
					<a class="mui-navigate-right" href="#">基础数据</a>
					<div class="mui-collapse-content">
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">厂别:</span>
							<span class="mui-col-xs-9"><input id="factoryName" type="text" value="" readonly /></span>
						</p>
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">MO号:</span>
							<span class="mui-col-xs-9"><input id="mo" type="text" value="" readonly /></span>
						</p>
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">生产编码:</span>
							<span class="mui-col-xs-9"><input id="mfg" type="text" value="" readonly /></span>
						</p>
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">工单号:</span>
							<span class="mui-col-xs-9"><input id="wo" type="text" value="" readonly /></span>
						</p>
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">客户代码:</span>
							<span class="mui-col-xs-9"><input id="custcode" type="text" value="" readonly /></span>
						</p>
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">客户型号:</span>
							<span class="mui-col-xs-9"><input id="custpart" type="text" value="" readonly /></span>
						</p>
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">LOT号:</span>
							<span class="mui-col-xs-9"><input id="lot" type="text" value="N/A" readonly /></span>
						</p>
						<p class="mui-row jichushuju">
							<span class="mui-col-xs-3">周期:</span>
							<span class="mui-col-xs-9"><input id="datecode" type="text" value="N/A" readonly /></span>
						</p>
						<p class="mui-row jichushuju" style="display: none;">
							<span class="mui-col-xs-3">d06rkey:</span>
							<span class="mui-col-xs-9"><input id="d06rkey" type="text" value="" readonly /></span>
						</p>

					</div>
				</li>
				<li class="mui-table-view-cell mui-collapse" style="color: indianred;text-align: left;padding: 0.5rem 1rem;">
					<a class="mui-navigate-right" href="#">板材二维码</a>
					<div class="mui-collapse-content">
						<p><input id="barcode" type="text" value="" data-id="bancai1" placeholder="点击扫描" /></p>
					</div>
					<div class="mui-collapse-content">
						<p><input id="materialBarcode" type="text" class="scan" value="" data-id="bancai" placeholder="轻触以打开扫描" readonly="readonly" /></p>
					</div>
				</li>
				<li class="mui-table-view-cell mui-collapse mui-active" style="color: coral;text-align: left;padding:0.5rem 1rem;">
					<a class="mui-navigate-right" href="#">实测数据</a>
					<div class="mui-collapse-content">
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">板材供应商:</span>
							<span class="mui-col-xs-9"><input id="plateSupplier" type="text" value="" /></span>
						</p>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">板材批次号:</span>
							<span class="mui-col-xs-9"><input id="plateLot" type="text" value="" /></span>
						</p>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">数量:</span>
							<span class="mui-col-xs-9"><input id="inputNum" type="text" value="" /></span>
						</p>
						<hr>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">板材规格:</span>
							<span class="mui-col-xs-9"><input id="plateSpec" type="text" value="" placeholder="单位mm" /></span>
						</p>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">尺寸要求:</span>
							<span class="mui-col-xs-9"><input id="reqSize" type="text" value="" placeholder="单位mm" /></span>
						</p>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">实际尺寸:</span>
							<span class="mui-col-xs-9"><input id="trimSize" type="text" value="" placeholder="单位mm" /></span>
						</p>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">裁切米数:</span>
							<span class="mui-col-xs-9"><input id="cutInmeters" type="text" value="" placeholder="单位mm" /></span>
						</p>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">裁切总米数:</span>
							<span class="mui-col-xs-9"><input id="cumuCutInmeters" type="text" value="" placeholder="单位mm" /></span>
						</p>
						<p class="mui-row shiceshuju">
							<span class="mui-col-xs-3">操作员:</span>
							<span class="mui-col-xs-9"><input id="operator" type="text" value="" /></span>
						</p>
						<p class="mui-row shiceshuju" style="display: none;">
							<span class="mui-col-xs-3">审核人:</span>
							<span class="mui-col-xs-9"><input id="auditor" type="text" value="" /></span>
						</p>
					</div>
				</li>
				<li class="mui-table-view-cell mui-collapse" style="color: slategray;text-align: left;padding: 0.5rem 1rem;">
					<a class="mui-navigate-right" href="#">备注</a>
					<div class="mui-collapse-content">
						<textarea rows="5" cols="" id="remark">

						</textarea>
					</div>
				</li>
			</ul>
			<ul class="mui-list-inline" style="text-align: center;">
				<li><button id="submit" type="button" class="mui-btn mui-btn-blue mui-btn-outlined" style="background-color: #009688;color: #fff;border-radius: 2px;">提交</button></li>
				<li><button id="reset" type="button" class="mui-btn mui-btn-blue mui-btn-outlined">重置</button></li>
			</ul>
		</div>
	</body>

	<script type="text/javascript">
		(function($, doc) {
			//初始化 scan页
			$.init({
				preloadPages: [{
					id: 'scan.html',
					url: '../scan.html'
				}]
			});

			document.querySelector("input[data-id='tiaoma1']").onchange = function() {
				var qrdata = document.getElementById("code").value;
				// 采集数据
				mui.ajax(realapi + '/JOVE_QIS/query/queryCommonDataByWO.action?id=2', {
					data: {
						wo: qrdata,
						isControl: false
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 3000, //超时时间设置为10秒；
					success: function(data) {

						if (data.success) {
							// 基础信息
							document.getElementById("mo").value = data.app.mo;
							document.getElementById("wo").value = data.app.wo;
							document.getElementById("mfg").value = data.app.mfg;
							document.getElementById("custcode").value = data.app.cust_code;
							document.getElementById("custpart").value = data.app.pn;
							document.getElementById("lot").value = data.app.lot;
							document.getElementById("datecode").value = data.app.datecode;
							document.getElementById("d06rkey").value = data.app.d06rkey;

							document.getElementById("reqSize").value = data.app.panels;
							document.getElementById("plateSpec").value = data.app.corerequirethick;
						} else {
							mui.alert(data.mess);
						}

					},
					error: function(xhr, type, errorThrown) {
						//异常处理
						if (type == "timeout")
							$.toast('连接超时，请检查网络')

						$.toast('系统异常，请检查是否连接jove-wifi')
					}
				})
			}
			document.querySelector("input[data-id='bancai1']").onchange = function() {
				var val = document.getElementById("barcode").value.trim().split(",");
				if (val.length != 11) {
					//板材二维码规格：供应商名称,料号,批次号,数量,尺寸,规格,生产日期,是否含铜,板厚,铜厚,TG值
					mui.toast("板材条码错误");
				} else {
					document.getElementById("plateSupplier").value = val[5];
					document.getElementById("plateLot").value = val[8];

					var corePlateThick = document.getElementById("plateSpec").value.trim();
					if (corePlateThick.length > 0) {
						document.getElementById("copperply").value = val[5] + " " + corePlateThick + " " + val[9];
					} else {
						document.getElementById("copperply").value = val[5] + " " + val[8] + " " + val[9];
					}
				}
			}

			//自定义事件,供扫描回调
			window.addEventListener('getScan', function(event) {
				// 获得事件参数
				// var id = event.detail.id;
				qrtype = event.detail.qrtype;
				qrdata = event.detail.qrdata;
				// 赋值到输入框
				if (qrtype && qrdata) {
					// mui.alert(qrtype + ":" + qrdata );
					var arr = qrdata.split(',');
					if (arr.length > 2) {
						qrdata = arr[1];
					}

					document.querySelector("input[data-id='" + qrtype + "']").value = qrdata;

					if (qrtype == 'tiaoma') {
						// 采集数据
						mui.ajax(realapi + '/JOVE_QIS/query/queryCommonDataByWO.action?id=2', {
							data: {
								wo: qrdata,
								isControl: false
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 3000, //超时时间设置为10秒；
							success: function(data) {

								if (data.success) {
									// 基础信息
									document.getElementById("mo").value = data.app.mo;
									document.getElementById("wo").value = data.app.wo;
									document.getElementById("mfg").value = data.app.mfg;
									document.getElementById("custcode").value = data.app.cust_code;
									document.getElementById("custpart").value = data.app.pn;
									document.getElementById("lot").value = data.app.lot;
									document.getElementById("datecode").value = data.app.datecode;
									document.getElementById("d06rkey").value = data.app.d06rkey;

									document.getElementById("reqSize").value = data.app.panels;
									document.getElementById("plateSpec").value = data.app.corerequirethick;
								} else {
									mui.alert(data.mess);
								}

							},
							error: function(xhr, type, errorThrown) {
								//异常处理
								if (type == "timeout")
									$.toast('连接超时，请检查网络')

								$.toast('系统异常，请检查是否连接jove-wifi')
							}
						})
					}

					if (qrtype == 'bancai') {
						var val = qrdata.trim().split(",");
						if (val.length != 11) {
							//板材二维码规格：供应商名称,料号,批次号,数量,尺寸,规格,生产日期,是否含铜,板厚,铜厚,TG值
							mui.toast("板材条码错误");
						} else {
							document.getElementById("plateSupplier").value = val[5];
							document.getElementById("plateLot").value = val[8];

							var corePlateThick = document.getElementById("plateSpec").value.trim();
							if (corePlateThick.length > 0) {
								document.getElementById("copperply").value = val[5] + " " + corePlateThick + " " + val[9];
							} else {
								document.getElementById("copperply").value = val[5] + " " + val[8] + " " + val[9];
							}
						}
					}
				}
			});

			$.plusReady(function() {
				// 获取本页面的固定信息
				var self = plus.webview.currentWebview();

				// 扫描页webview
				var scanPage = null;
				document.querySelectorAll(".scan").forEach(function(el) {
					el.addEventListener('tap', function() {
						// 扫描页webview
						if (!scanPage) {
							scanPage = plus.webview.getWebviewById('scan.html');
						}
						// 这里只有qrtype 是不一样的,根据el来
						var qrtype = el.getAttribute("data-id");
						mui.fire(scanPage, 'newScan', {
							qrtype: qrtype,
							source: self.openurl,
							sourceid: self.id
						});
						mui.openWindow({
							id: 'scan.html'
						});
					})
				})

				// 登录状态消息
				var state = app.getState();
				document.getElementById("factoryName").value = state.changbie;
				document.getElementById("operator").value = state.username;

				// 表单
				document.getElementById("submit").addEventListener('tap', function() {
					if (!confirm("确认提交吗？"))
						return;

					if (document.getElementById("remark").value.length > 30) {
						mui.alert("备注超过30字");
						return;
					}

					var facarr = {
						'一厂': 1,
						'二厂': 2,
						'三厂': 3,
						'未知': 'N/A'
					}
					factoryName = facarr[document.getElementById("factoryName").value];
					var data = {
						factoryName: factoryName,
						mo: document.getElementById("mo").value,
						mfg: document.getElementById("mfg").value,
						wo: document.getElementById("wo").value,
						custcode: document.getElementById("custcode").value,
						custpart: document.getElementById("custpart").value,
						lot: document.getElementById("lot").value,
						datecode: document.getElementById("datecode").value,
						d06rkey: document.getElementById("d06rkey").value,

						plateSupplier: document.getElementById("plateSupplier").value,
						plateLot: document.getElementById("plateLot").value,
						inputNum: document.getElementById("inputNum").value,
						plateSpec: document.getElementById("plateSpec").value,
						reqSize: document.getElementById("reqSize").value,
						trimSize: document.getElementById("trimSize").value,
						cutInmeters: document.getElementById("cutInmeters").value,
						cumuCutInmeters: document.getElementById("cumuCutInmeters").value,
						operator: document.getElementById("operator").value,
						auditor: document.getElementById("auditor").value,
						remark: document.getElementById("remark").value,
					}

					// for(var key in data){
					// 	if(data[key] == undefined || data[key] == null || data[key] == ''){
					// 		mui.alert("必填项不能为空");
					// 		return;
					// 	}
					// }

					var params = JSON.stringify(data);
					mui.ajax({
						url: realapi + '/JOVE_QIS/query/saveVerifyData.action?id=2',
						type: "post",
						data: {
							params: params,
							isRejectItem: false
						},
						dataType: "json",
						async: false,
						error: function() {
							mui.alert("error occur!");
						},
						success: function(data) {
							if (data.isOK) {
								mui.alert("上传成功!");
							} else {
								mui.alert("未知错误。");
							}
						}
					});
				});
				document.getElementById("reset").addEventListener('tap', function() {
					if (!confirm("确认重置吗？"))
						return;

					document.getElementById("plateSupplier").value = '';
					document.getElementById("plateLot").value = '';
					document.getElementById("inputNum").value = '';
					document.getElementById("plateSpec").value = '';
					document.getElementById("reqSize").value = '';
					document.getElementById("trimSize").value = '';
					document.getElementById("cutInmeters").value = '';
					document.getElementById("cumuCutInmeters").value = '';
					document.querySelectorAll("input[name='speccut']").forEach(function(el) {
						el.checked = false;
					})
					document.querySelectorAll("input[name='decide']").forEach(function(el) {
						el.checked = false;
					})
					document.querySelectorAll("input[name='rejectitem']").forEach(function(el) {
						el.checked = false;
					})
					document.getElementById("remark").value = '';
				});

			});
		}(mui, document));
	</script>
</html>
